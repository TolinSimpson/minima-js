import {createElement} from './minima-core.js';const DANGEROUS_TAGS=new Set(['script','iframe','object','embed','applet','meta','link','style','form','input','button','select','textarea','option','optgroup']);const DANGEROUS_ATTRS=new Set(['onload','onerror','onclick','onmouseover','onfocus','onblur','onchange','onsubmit','onkeydown','onkeyup','onkeypress','onmousedown','onmouseup','onmousemove','onmouseout','onmouseenter','onmouseleave','onscroll','onresize','onhashchange','onpopstate','onbeforeunload','onunload','onmessage','onstorage','ononline','onoffline','onabort','oncanplay','oncanplaythrough','ondurationchange','onemptied','onended','oninput','oninvalid','onpause','onplay','onplaying','onprogress','onratechange','onseeked','onseeking','onstalled','onsuspend','ontimeupdate','onvolumechange','onwaiting','onafterprint','onbeforeprint','onabort','oncanplay','oncanplaythrough','oncontextmenu','oncuechange','ondblclick','ondrag','ondragend','ondragenter','ondragleave','ondragover','ondragstart','ondrop','ondurationchange','onemptied','onended','onformchange','onforminput','oninput','oninvalid','onpause','onplay','onplaying','onprogress','onratechange','onreset','onseeked','onseeking','onselect','onshow','onstalled','onsubmit','onsuspend','ontimeupdate','ontoggle','onvolumechange','onwaiting','onwheel','oncopy','oncut','onpaste','onauxclick','onpointerdown','onpointerup','onpointermove','onpointerover','onpointerout','onpointerenter','onpointerleave','onpointercancel','ongotpointercapture','onlostpointercapture']);const URL_ATTRS=new Set(['href','src','action','formaction','data','background','poster','icon','manifest','content','cite','longdesc','usemap','formtarget']);const sanitizeText=(text)=> {if(typeof text !=='string')return String(text);return text.replace(/[<>"'\/]/g,(match)=> {switch(match){case '<':return '&lt;';case '>':return '&gt;';case '"':return '&quot;';case "'":return '&#x27;';case '/':return '&#x2F;';default:return match;}});};const isValidUrl=(url)=> {if(typeof url !=='string')return false;const trimmed=url.trim().toLowerCase();return !(trimmed.startsWith('javascript:')||trimmed.startsWith('data:')||trimmed.startsWith('vbscript:')||trimmed.includes('javascript:'));};const sanitizeAttr=(name,value)=> {const nameLower=name.toLowerCase();if(DANGEROUS_ATTRS.has(nameLower))return null;if(URL_ATTRS.has(nameLower)&&!isValidUrl(value))return null;if(typeof value==='string'){return value.replace(/["']/g,(match)=> match==='"'?'&quot;':'&#x27;');} return value;};const parseHTML=(html)=> {const tokens=[];let i=0;while(i < html.length){if(html[i]==='<'){const tagEnd=html.indexOf('>',i);if(tagEnd===-1)break;const tagContent=html.slice(i + 1,tagEnd);const isClosing=tagContent.startsWith('/');const tagName=(isClosing?tagContent.slice(1):tagContent).split(/\s/)[0].toLowerCase();if(isClosing){tokens.push({type:'close',tag:tagName});} else {const attrs=parseAttrs(tagContent.slice(tagName.length));tokens.push({type:'open',tag:tagName,attrs,self:tagContent.endsWith('/')});} i=tagEnd + 1;} else {const nextTag=html.indexOf('<',i);const text=html.slice(i,nextTag===-1?html.length:nextTag).trim();if(text)tokens.push({type:'text',content:text});i=nextTag===-1?html.length:nextTag;}} return tokens;};const parseAttrs=(attrStr)=> {const attrs={};const regex=/(\w+)(?:=["']([^"']*?)["'])?/g;let match;while((match=regex.exec(attrStr))!==null){const[,name,value='']=match;const sanitized=sanitizeAttr(name,value);if(sanitized !==null)attrs[name]=sanitized;} return attrs;};const tokensToVNode=(tokens)=> {const stack=[{children:[]}];tokens.forEach(token=> {const current=stack[stack.length - 1];switch(token.type){case 'text':current.children.push(sanitizeText(token.content));break;case 'open':if(DANGEROUS_TAGS.has(token.tag))break;const element={type:token.tag,props:{...token.attrs},children:[]};current.children.push(element);if(!token.self)stack.push(element);break;case 'close':if(stack.length > 1&&!DANGEROUS_TAGS.has(token.tag)){stack.pop();} break;}});return stack[0].children;};const html=(strings,...values)=> {let result='';for(let i=0;i < strings.length;i++){result +=strings[i];if(i < values.length){const value=values[i];if(typeof value==='function'){result +=`__HANDLER_${i}__`;} else if(Array.isArray(value)){for(let j=0;j < value.length;j++){const item=value[j];result +=typeof item==='string'?sanitizeText(item):'__VNODE__';}} else {result +=sanitizeText(value);}}} const tokens=parseHTML(result);const vnodes=tokensToVNode(tokens);const processVNode=(vnode)=> {if(typeof vnode==='string'){return vnode.replace(/__HANDLER_(\d+)__/g,(match,idx)=> {const handler=values[parseInt(idx)];return typeof handler==='function'?handler:match;});} if(vnode?.type&&vnode.props){const props=vnode.props;for(const key in props){const value=props[key];if(typeof value==='string'&&value.includes('__HANDLER_')){const handlerMatch=value.match(/__HANDLER_(\d+)__/);if(handlerMatch){const handlerIdx=parseInt(handlerMatch[1]);const handler=values[handlerIdx];if(typeof handler==='function'){const eventName=key.startsWith('on')?key:`on${key}`;delete props[key];props[eventName]=handler;}}}} if(vnode.children?.length){const processedChildren=new Array(vnode.children.length);for(let i=0;i < vnode.children.length;i++){processedChildren[i]=processVNode(vnode.children[i]);} vnode.children=processedChildren;vnode.props.children=vnode.children;} return createElement(vnode.type,vnode.props,...vnode.children);} return vnode;};if(vnodes.length===1){return processVNode(vnodes[0]);} else if(vnodes.length > 1){return createElement('div',{className:'minima-fragment'},...vnodes.map(processVNode));} else {return null;}};const loadTemplate=async(url)=> {if(!isValidUrl(url))throw new Error('Invalid template URL');const response=await fetch(url);const text=await response.text();return html([text]);};export {html,loadTemplate,sanitizeText};
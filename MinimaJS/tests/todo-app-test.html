<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Todo App Integration Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: #f8f9fa;
    }
    
    .test-header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 8px;
    }
    
    .test-section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .test-result {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      border-left: 4px solid;
    }
    
    .test-result.pass {
      background: #d4edda;
      border-left-color: #28a745;
      color: #155724;
    }
    
    .test-result.fail {
      background: #f8d7da;
      border-left-color: #dc3545;
      color: #721c24;
    }
    
    .test-result.info {
      background: #d1ecf1;
      border-left-color: #17a2b8;
      color: #0c5460;
    }
    
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    
    button:hover {
      background: #5a6fd8;
    }
    
    .demo-area {
      border: 2px dashed #ddd;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      background: #fafafa;
    }
    
    input[type="text"] {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin: 5px;
      width: 200px;
    }
    
    .todo-item {
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 10px;
      margin: 5px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .todo-item.completed {
      opacity: 0.6;
      text-decoration: line-through;
    }
    
    .stats {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }
  </style>
</head>
<body>
  <div class="test-header">
    <h1>üìù Todo App Integration Test</h1>
    <p>Testing the todo application functionality end-to-end</p>
  </div>

  <div id="test-results">
    <div class="test-section">
      <h3>üîÑ Test Status</h3>
      <p>Initializing tests...</p>
    </div>
  </div>

  <div class="test-section">
    <h3>üéÆ Interactive Todo Test</h3>
    <p>Use this live todo app to manually test functionality:</p>
    <div class="demo-area" id="todo-demo">
      <p>Loading todo app...</p>
    </div>
  </div>

  <!-- Load MinimaJS Framework -->
  <script src="../src/minima.js"></script>
  <script src="../src/minima.dev.js"></script>

  <script>
    // =========================================================================
    // TODO APP TEST IMPLEMENTATION
    // =========================================================================
    
    // Global test results
    const testResults = [];
    
    function logTest(name, passed, message = '') {
      testResults.push({
        name: name,
        passed: passed,
        message: message,
        timestamp: new Date().toISOString()
      });
      
      console.log(`${passed ? '‚úÖ' : '‚ùå'} ${name}${message ? ': ' + message : ''}`);
    }
    
    function renderTestResults() {
      const container = document.getElementById('test-results');
      
      const passedTests = testResults.filter(t => t.passed).length;
      const totalTests = testResults.length;
      const successRate = totalTests > 0 ? Math.round((passedTests / totalTests) * 100) : 0;
      
      let html = `
        <div class="test-section">
          <h3>üìä Test Results</h3>
          <div class="test-result info">
            <strong>Summary:</strong> ${passedTests}/${totalTests} tests passed (${successRate}%)
          </div>
      `;
      
      for (const test of testResults) {
        html += `
          <div class="test-result ${test.passed ? 'pass' : 'fail'}">
            <strong>${test.passed ? '‚úÖ' : '‚ùå'} ${test.name}</strong>
            ${test.message ? `<br><small>${test.message}</small>` : ''}
          </div>
        `;
      }
      
      html += `</div>`;
      container.innerHTML = html;
    }

    // =========================================================================
    // TODO STORE AND COMPONENTS
    // =========================================================================
    
    // Create todo store for testing
    const todoStore = MinimaJS.store('test-todos', {
      items: [
        { id: 1, text: 'Initial test todo', completed: false, createdAt: Date.now() - 1000 },
        { id: 2, text: 'Completed test todo', completed: true, createdAt: Date.now() - 2000 }
      ],
      nextId: 3,
      filter: 'all',
      newTodoText: ''
    });
    
    // Todo Input Component
    const TodoInput = MinimaJS.defineComponent(function(props) {
      const addTodo = () => {
        const text = todoStore.newTodoText.trim();
        if (text) {
          todoStore.items = [
            ...todoStore.items,
            {
              id: todoStore.nextId++,
              text: text,
              completed: false,
              createdAt: Date.now()
            }
          ];
          todoStore.newTodoText = '';
          
          // Log test result
          logTest('Add Todo', true, `Added todo: "${text}"`);
        }
      };
      
      const updateInput = (event) => {
        todoStore.newTodoText = event.target.value;
      };
      
      // Expose functions globally for testing
      window.testAddTodo = addTodo;
      window.testUpdateInput = updateInput;
      
      return `
        <div style="margin-bottom: 20px;">
          <input 
            type="text" 
            placeholder="Add a new todo..." 
            value="${todoStore.newTodoText}"
            oninput="testUpdateInput(event)"
            onkeypress="if(event.key==='Enter') testAddTodo()"
          />
          <button onclick="testAddTodo()">Add Todo</button>
        </div>
      `;
    });
    
    // Todo List Component
    const TodoList = MinimaJS.defineComponent(function(props) {
      const toggleTodo = (id) => {
        todoStore.items = todoStore.items.map(todo =>
          todo.id === id ? { ...todo, completed: !todo.completed } : todo
        );
        
        const todo = todoStore.items.find(t => t.id === id);
        logTest('Toggle Todo', true, `Toggled "${todo.text}" to ${todo.completed ? 'completed' : 'active'}`);
      };
      
      const deleteTodo = (id) => {
        const todo = todoStore.items.find(t => t.id === id);
        todoStore.items = todoStore.items.filter(todo => todo.id !== id);
        
        logTest('Delete Todo', true, `Deleted "${todo.text}"`);
      };
      
      const setFilter = (filter) => {
        todoStore.filter = filter;
        logTest('Filter Change', true, `Changed filter to "${filter}"`);
      };
      
      // Expose functions globally
      window.testToggleTodo = toggleTodo;
      window.testDeleteTodo = deleteTodo;
      window.testSetFilter = setFilter;
      
      const getFilteredTodos = () => {
        switch (todoStore.filter) {
          case 'active':
            return todoStore.items.filter(todo => !todo.completed);
          case 'completed':
            return todoStore.items.filter(todo => todo.completed);
          default:
            return todoStore.items;
        }
      };
      
      const filteredTodos = getFilteredTodos();
      const totalCount = todoStore.items.length;
      const completedCount = todoStore.items.filter(t => t.completed).length;
      const activeCount = totalCount - completedCount;
      
      // Generate filter buttons
      const filterButtons = `
        <div style="margin-bottom: 15px;">
          <button 
            onclick="testSetFilter('all')" 
            ${todoStore.filter === 'all' ? 'style="background: #28a745;"' : 'style="background: #6c757d;"'}
          >
            All (${totalCount})
          </button>
          <button 
            onclick="testSetFilter('active')" 
            ${todoStore.filter === 'active' ? 'style="background: #28a745;"' : 'style="background: #6c757d;"'}
          >
            Active (${activeCount})
          </button>
          <button 
            onclick="testSetFilter('completed')" 
            ${todoStore.filter === 'completed' ? 'style="background: #28a745;"' : 'style="background: #6c757d;"'}
          >
            Completed (${completedCount})
          </button>
        </div>
      `;
      
      // Generate todo items
      const todoItemsHtml = filteredTodos.map(todo => `
        <div class="todo-item ${todo.completed ? 'completed' : ''}">
          <div style="display: flex; align-items: center; gap: 10px;">
            <input 
              type="checkbox" 
              ${todo.completed ? 'checked' : ''}
              onchange="testToggleTodo(${todo.id})"
            />
            <span>${todo.text}</span>
          </div>
          <button onclick="testDeleteTodo(${todo.id})" style="background: #dc3545;">
            Delete
          </button>
        </div>
      `).join('');
      
      // Generate statistics
      const stats = `
        <div class="stats">
          <strong>Statistics:</strong> 
          ${totalCount} total, 
          ${activeCount} active, 
          ${completedCount} completed
          <br>
          <strong>Filter:</strong> ${todoStore.filter}
          <br>
          <strong>Completion Rate:</strong> ${totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0}%
        </div>
      `;
      
      return `
        <div>
          ${filterButtons}
          <div style="margin-bottom: 15px;">
            ${todoItemsHtml || '<p><em>No todos match the current filter</em></p>'}
          </div>
          ${stats}
        </div>
      `;
    });
    
    // Main Todo App Component
    const TodoApp = MinimaJS.defineComponent(function(props) {
      return `
        <div>
          <h4>üéØ Interactive Todo App Test</h4>
          ${TodoInput({})._template || ''}
          ${TodoList({})._template || ''}
        </div>
      `;
    });

    // =========================================================================
    // AUTOMATED TESTS
    // =========================================================================
    
    function runAutomatedTests() {
      console.log('üß™ Running automated todo app tests...');
      
      // Test 1: Initial state
      try {
        const initialItems = todoStore.items.length;
        logTest('Initial State', initialItems >= 2, `Found ${initialItems} initial todos`);
      } catch (error) {
        logTest('Initial State', false, error.message);
      }
      
      // Test 2: Store reactivity
      try {
        let changeDetected = false;
        const unsubscribe = todoStore._subscribe(() => {
          changeDetected = true;
        });
        
        todoStore.filter = 'test';
        todoStore.filter = 'all'; // Reset
        
        setTimeout(() => {
          logTest('Store Reactivity', changeDetected, 'Store change subscription working');
          unsubscribe();
        }, 10);
      } catch (error) {
        logTest('Store Reactivity', false, error.message);
      }
      
      // Test 3: Component creation
      try {
        const todoInput = TodoInput({});
        const todoList = TodoList({});
        
        logTest('Component Creation', !!(todoInput && todoList), 'Todo components created successfully');
      } catch (error) {
        logTest('Component Creation', false, error.message);
      }
      
      // Test 4: Filter functionality
      try {
        const originalFilter = todoStore.filter;
        
        // Test all filters
        todoStore.filter = 'all';
        const allTodos = todoStore.items.length;
        
        todoStore.filter = 'active';
        const activeTodos = todoStore.items.filter(t => !t.completed).length;
        
        todoStore.filter = 'completed';
        const completedTodos = todoStore.items.filter(t => t.completed).length;
        
        todoStore.filter = originalFilter; // Reset
        
        logTest('Filter Functionality', allTodos === (activeTodos + completedTodos), 
               `All: ${allTodos}, Active: ${activeTodos}, Completed: ${completedTodos}`);
      } catch (error) {
        logTest('Filter Functionality', false, error.message);
      }
      
      // Test 5: Todo operations
      try {
        const initialCount = todoStore.items.length;
        
        // Add a test todo
        todoStore.items = [
          ...todoStore.items,
          { id: Date.now(), text: 'Automated test todo', completed: false, createdAt: Date.now() }
        ];
        
        const afterAdd = todoStore.items.length;
        
        // Remove the test todo
        todoStore.items = todoStore.items.filter(todo => todo.text !== 'Automated test todo');
        
        const afterRemove = todoStore.items.length;
        
        logTest('Todo Operations', 
               afterAdd === initialCount + 1 && afterRemove === initialCount,
               `Add: ${afterAdd}, Remove: ${afterRemove}`);
      } catch (error) {
        logTest('Todo Operations', false, error.message);
      }
      
      // Test 6: Performance test
      try {
        const startTime = performance.now();
        
        // Create many todos quickly
        const testTodos = [];
        for (let i = 0; i < 100; i++) {
          testTodos.push({
            id: Date.now() + i,
            text: `Performance test todo ${i}`,
            completed: Math.random() > 0.5,
            createdAt: Date.now()
          });
        }
        
        todoStore.items = [...todoStore.items, ...testTodos];
        
        // Clean up
        todoStore.items = todoStore.items.filter(todo => !todo.text.includes('Performance test'));
        
        const endTime = performance.now();
        const duration = endTime - startTime;
        
        logTest('Performance Test', duration < 100, `Handled 100 todos in ${duration.toFixed(2)}ms`);
      } catch (error) {
        logTest('Performance Test', false, error.message);
      }
      
      // Render results after a short delay to allow async tests to complete
      setTimeout(() => {
        renderTestResults();
        
        // Add manual test instructions
        const container = document.getElementById('test-results');
        container.innerHTML += `
          <div class="test-section">
            <h3>üìã Manual Test Instructions</h3>
            <div class="test-result info">
              <strong>Manual Tests to Perform:</strong>
              <ul style="margin: 10px 0; padding-left: 20px;">
                <li>Add a new todo using the input field</li>
                <li>Toggle todo completion by clicking checkboxes</li>
                <li>Delete todos using the delete buttons</li>
                <li>Switch between All/Active/Completed filters</li>
                <li>Verify statistics update correctly</li>
              </ul>
            </div>
            <button onclick="window.location.href='../examples/todo-app.html'">üöÄ Open Full Todo App</button>
            <button onclick="runStressTest()">‚ö° Run Stress Test</button>
            <button onclick="exportTestResults()">üìä Export Results</button>
          </div>
        `;
      }, 100);
    }
    
    // Stress test function
    window.runStressTest = function() {
      console.log('‚ö° Running stress test...');
      
      const startTime = performance.now();
      let operationsCount = 0;
      
      // Add many todos
      for (let i = 0; i < 50; i++) {
        todoStore.items = [
          ...todoStore.items,
          {
            id: Date.now() + i,
            text: `Stress test todo ${i}`,
            completed: false,
            createdAt: Date.now()
          }
        ];
        operationsCount++;
      }
      
      // Toggle many todos
      todoStore.items = todoStore.items.map(todo => {
        if (todo.text.includes('Stress test')) {
          operationsCount++;
          return { ...todo, completed: !todo.completed };
        }
        return todo;
      });
      
      // Clean up
      todoStore.items = todoStore.items.filter(todo => !todo.text.includes('Stress test'));
      operationsCount += 50; // For deletions
      
      const endTime = performance.now();
      const duration = endTime - startTime;
      
      alert(`‚ö° Stress Test Complete!\n\nOperations: ${operationsCount}\nTime: ${duration.toFixed(2)}ms\nAverage: ${(duration/operationsCount).toFixed(3)}ms per operation`);
      
      logTest('Stress Test', duration < 1000, `${operationsCount} operations in ${duration.toFixed(2)}ms`);
      renderTestResults();
    };
    
    // Export test results
    window.exportTestResults = function() {
      const results = {
        timestamp: new Date().toISOString(),
        userAgent: navigator.userAgent,
        testResults: testResults,
        performance: MinimaJS.dev ? MinimaJS.dev.getPerformanceStats() : null,
        framework: {
          components: MinimaJS.dev ? MinimaJS.dev.listComponents() : [],
          stores: Object.keys(MinimaJS._globalStores || {})
        }
      };
      
      const dataStr = JSON.stringify(results, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      
      const link = document.createElement('a');
      link.href = URL.createObjectURL(dataBlob);
      link.download = `minimajs-test-results-${Date.now()}.json`;
      link.click();
      
      console.log('üìä Test results exported:', results);
    };

    // =========================================================================
    // INITIALIZATION
    // =========================================================================
    
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ Starting Todo App Integration Test...');
      
      // Render the todo app demo
      const demoContainer = document.getElementById('todo-demo');
      MinimaJS.render(TodoApp, demoContainer);
      
      // Run automated tests
      setTimeout(runAutomatedTests, 500);
      
      console.log('‚úÖ Todo app test initialized');
      console.log('üéÆ Use the interactive demo above to test functionality');
    });
  </script>
</body>
</html>